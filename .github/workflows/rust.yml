name: Rust

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            arch: amd64
            artifact_name: hello_action.exe
            os_type: windows
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            arch: arm64
            artifact_name: hello_action.exe
            os_type: windows
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            arch: x64
            artifact_name: hello_action
            os_type: linux
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            arch: arm64
            artifact_name: hello_action
            os_type: linux

    runs-on: ${{ matrix.os }}
    permissions: write-all
    
    outputs:
      tag_name: ${{ steps.get_tag.outputs.tag }}

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        components: rust-src

    - name: Install cross-compilation tools for Linux ARM64
      if: ${{ matrix.target == 'aarch64-unknown-linux-musl' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools
        echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

    - name: Build release
      run: |
        rustup target add ${{ matrix.target }}
        cargo build --release --target ${{ matrix.target }}
      
    - name: Set tag name
      id: get_tag
      run: |
        if [ "${GITHUB_REF#refs/tags/}" != "${GITHUB_REF}" ]; then
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "tag=v$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: "hello_action_${{ matrix.arch }}_${{ matrix.os_type }}"
        path: ./target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions: write-all
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Rename artifacts for unique names
      run: |
        # List all directories first for debugging
        echo "Listing artifacts directory structure:"
        ls -la ./artifacts
        
        # Create release assets directory
        mkdir -p ./release_assets
        
        for dir in ./artifacts/*; do
          if [ -d "$dir" ]; then
            echo "\nProcessing directory: $dir"
            # Get the directory name (e.g., hello_action_amd64_windows)
            dir_name=$(basename "$dir")
            echo "Directory name: $dir_name"
            
            # Get the artifact file inside
            for file in "$dir"/*; do
              if [ -f "$file" ]; then
                echo "Found file: $file"
                # Get just the filename without path
                filename=$(basename "$file")
                echo "Filename: $filename"
                
                # Get the original file extension
                ext="${filename##*.}"
                if [ "$ext" = "$filename" ]; then
                  ext=""
                  echo "No extension found"
                else
                  ext=".${ext}"
                  echo "Extension: $ext"
                fi
                
                # Create new filename with architecture and OS
                # Extract arch and OS from directory name (e.g., amd64_windows from hello_action_amd64_windows)
                arch_os="${dir_name#hello_action_}"
                echo "Arch_OS part: $arch_os"
                new_name="hello_action_${arch_os}${ext}"
                echo "New name: $new_name"
                
                # Rename the file and move it to a flat structure
                echo "Moving $file to ./release_assets/$new_name"
                mv "$file" "./release_assets/$new_name"
                
                # Verify the move was successful
                if [ -f "./release_assets/$new_name" ]; then
                  echo "✓ Move successful: ./release_assets/$new_name"
                else
                  echo "✗ Move failed!"
                fi
              fi
            done
          fi
        done
        
        # List the final release assets
        echo "\nFinal release assets:"
        ls -la ./release_assets
      shell: bash

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.build.outputs.tag_name }}
        name: Release ${{ needs.build.outputs.tag_name }}
        draft: false
        prerelease: false
        files: ./release_assets/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    #- name: copy file via ssh password
    #  uses: appleboy/scp-action@v0.1.4
    #  with:
    #    host: you host Ip addr or domain name
    #    username: root
    #    password: yousshPassword
    #    port: 22
    #    source: "./target/x86_64-unknown-linux-musl/release/hello_action"
    #    target: "/root/hello_action"

  releaseDocker:
    needs: build
    runs-on: ubuntu-latest
    permissions: write-all
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Rename artifacts for unique names
      run: |
        # List all directories first for debugging
        echo "Listing artifacts directory structure:"
        ls -la ./artifacts
        
        # Create release assets directory
        mkdir -p ./release_assets
        
        for dir in ./artifacts/*; do
          if [ -d "$dir" ]; then
            echo "\nProcessing directory: $dir"
            # Get the directory name (e.g., hello_action_amd64_windows)
            dir_name=$(basename "$dir")
            echo "Directory name: $dir_name"
            
            # Get the artifact file inside
            for file in "$dir"/*; do
              if [ -f "$file" ]; then
                echo "Found file: $file"
                # Get just the filename without path
                filename=$(basename "$file")
                echo "Filename: $filename"
                
                # Get the original file extension
                ext="${filename##*.}"
                if [ "$ext" = "$filename" ]; then
                  ext=""
                  echo "No extension found"
                else
                  ext=".${ext}"
                  echo "Extension: $ext"
                fi
                
                # Create new filename with architecture and OS
                # Extract arch and OS from directory name (e.g., amd64_windows from hello_action_amd64_windows)
                arch_os="${dir_name#hello_action_}"
                echo "Arch_OS part: $arch_os"
                new_name="hello_action_${arch_os}${ext}"
                echo "New name: $new_name"
                
                # Rename the file and move it to a flat structure
                echo "Moving $file to ./release_assets/$new_name"
                mv "$file" "./release_assets/$new_name"
                
                # Verify the move was successful
                if [ -f "./release_assets/$new_name" ]; then
                  echo "✓ Move successful: ./release_assets/$new_name"
                else
                  echo "✗ Move failed!"
                fi
              fi
            done
          fi
        done
        
        # List the final release assets
        echo "\nFinal release assets:"
        ls -la ./release_assets
      shell: bash
       
    - name: Make artifacts executable
      run: |
        cp ./artifacts/release_assets/hello_action_x64_linux ./target/release/hello_action
        cp ./artifacts/release_assets/hello_action_arm64_linux ./target/aarch64-unknown-linux-gnu/release/hello_action
        chmod +x target/release/hello_action
        chmod +x target/aarch64-unknown-linux-gnu/release/hello_action
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Extract metadata (tags, labels)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_HUB_USERNAME }}/hello_action
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/amd64,linux/arm64
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max